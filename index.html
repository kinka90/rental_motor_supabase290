<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aplikasi Sewa Motor – Supabase Realtime</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body { font-family: Arial; background:#f5f5f5; margin:0; padding:0; }
  header { background:#1e40af; padding:15px; color:white; text-align:center; }
  main { padding:15px; }
  button { padding:8px 14px; margin:4px; background:#1e40af; color:white; border:none; border-radius:6px; cursor:pointer; }
  button.red { background:#d32f2f; }
  .card {
    background:white; padding:12px; border-radius:8px; border:1px solid #ccc;
    display:flex; gap:12px; margin-bottom:12px; align-items:center;
  }
  .card img { width:120px; height:80px; border-radius:6px; object-fit:cover; }
  #adminPanel { display:none; background:white; padding:10px; margin-top:10px; border-radius:8px; }
  table { border-collapse:collapse; width:100%; background:white; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:6px; text-align:left; }
  footer { background:#1e40af; color:white; text-align:center; padding:12px; margin-top:20px; }
</style>

</head>
<body>

<header>
  <h2>Aplikasi Sewa Motor</h2>
  <button id="loginBtn"><i class="fa-brands fa-google"></i> Login Google</button>
  <button id="logoutBtn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  <button id="adminBtn"><i class="fa-solid fa-lock"></i> Admin</button><br>
  <small id="userInfo"></small>
</header>

<main>

<h3>Daftar Motor</h3>
<div id="bikeList"></div>

<div id="adminPanel">
  <h3>Panel Admin</h3>
  <button id="addBikeBtn">+ Tambah Motor</button>
  <button id="pdfBtn"><i class="fa-solid fa-file-pdf"></i> Export PDF Buku Kas</button>

  <h3>Buku Kas</h3>
  <table>
    <thead>
      <tr><th>Motor</th><th>Penyewa</th><th>Durasi</th><th>Total</th><th>Tanggal</th></tr>
    </thead>
    <tbody id="kasTable"></tbody>
  </table>
</div>

</main>

<footer>
  Rental Motor — Aman, Mudah, Realtime
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">

// ======================================================
// SUPABASE INIT
// ======================================================
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON = "YOUR_SUPABASE_ANON";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

const ADMIN_EMAIL = "kinkinka90@gmail.com";

// ELEMENT
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfo = document.getElementById("userInfo");
const adminBtn = document.getElementById("adminBtn");
const adminPanel = document.getElementById("adminPanel");
const bikeList = document.getElementById("bikeList");
const kasTable = document.getElementById("kasTable");
const addBikeBtn = document.getElementById("addBikeBtn");
const pdfBtn = document.getElementById("pdfBtn");

let isAdmin = false;

// ======================================================
// LOGIN GOOGLE
// ======================================================
loginBtn.onclick = async () => {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.href }
  });
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

// ======================================================
// AUTH STATE CHANGE
// ======================================================
supabase.auth.onAuthStateChange(async (_, session) => {
  const user = session?.user;

  if (user) {
    userInfo.textContent = "Login sebagai: " + user.email;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";

    if (user.email === ADMIN_EMAIL) isAdmin = true;
  }

  renderAdminPanel();
  loadBikes();
  loadKas();
  watchKasRealtime();
});

// ======================================================
// ADMIN PANEL TOGGLE
// ======================================================
function renderAdminPanel() {
  adminPanel.style.display = isAdmin ? "block" : "none";
  adminBtn.innerHTML = isAdmin
    ? "<i class='fa-solid fa-lock-open'></i> Admin"
    : "<i class='fa-solid fa-lock'></i> Admin";
}

adminBtn.onclick = () => {
  if (!isAdmin) return alert("Anda bukan admin!");
  adminPanel.style.display = adminPanel.style.display === "none" ? "block" : "none";
};

// ======================================================
// LOAD MOTOR
// ======================================================
async function loadBikes() {
  const { data } = await supabase.from("bikes").select("*").order("id");
  renderBikes(data || []);
}

function renderBikes(list) {
  bikeList.innerHTML = "";
  list.forEach(m => {
    let c = document.createElement("div");
    c.className = "card";

    c.innerHTML = `
      <img src="${m.image}">
      <div>
        <b>${m.name}</b><br>
        Rp ${m.hour}/jam — Rp ${m.day}/hari<br><br>
        ${isAdmin ? `
        <button onclick="editBike(${m.id})">Edit</button>
        <button class="red" onclick="deleteBike(${m.id})">Hapus</button>
        ` : ""}
        <button onclick="rentBike(${m.id})">Sewa</button>
      </div>
    `;

    bikeList.appendChild(c);
  });
}

// ======================================================
// TAMBAH MOTOR
// ======================================================
addBikeBtn.onclick = () => {
  const name = prompt("Nama motor:");
  const hour = prompt("Tarif per jam:");
  const day = prompt("Tarif per hari:");

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";

  fileInput.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = async ev => {
      await supabase.from("bikes").insert({
        name, hour, day, image: ev.target.result
      });
      loadBikes();
    };

    reader.readAsDataURL(file);
  };

  fileInput.click();
};

// ======================================================
// EDIT MOTOR
// ======================================================
window.editBike = async (id) => {
  const { data } = await supabase.from("bikes").select("*").eq("id", id).single();
  if (!data) return;

  const name = prompt("Nama baru:", data.name) || data.name;
  const hour = prompt("Tarif per jam:", data.hour) || data.hour;
  const day = prompt("Tarif per hari:", data.day) || data.day;

  let img = data.image;

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";

  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      const r = new FileReader();
      r.onload = async ev => {
        img = ev.target.result;
        await updateBike();
      };
      r.readAsDataURL(file);
    } else updateBike();
  };

  fileInput.click();

  async function updateBike() {
    await supabase.from("bikes").update({
      name, hour, day, image: img
    }).eq("id", id);

    loadBikes();
    alert("Motor diperbarui!");
  }
};

// ======================================================
// HAPUS MOTOR
// ======================================================
window.deleteBike = async (id) => {
  if (!confirm("Hapus motor?")) return;
  await supabase.from("bikes").delete().eq("id", id);
  loadBikes();
};

// ======================================================
// SEWA MOTOR → MASUK BUKU KAS
// ======================================================
window.rentBike = async (id) => {
  const penyewa = prompt("Nama penyewa:");
  const durasi = prompt("Durasi:");
  const total = prompt("Total bayar:");

  await supabase.from("kas").insert({
    bike_id: id,
    penyewa, durasi, total,
    tanggal: new Date().toISOString()
  });

  alert("Penyewaan dicatat!");
};

// ======================================================
// LOAD KAS
// ======================================================
async function loadKas() {
  const { data } = await supabase
    .from("kas")
    .select("*, bikes(name)")
    .order("id");

  renderKas(data || []);
}

function renderKas(list) {
  kasTable.innerHTML = "";
  list.forEach(k => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${k.bikes.name}</td>
      <td>${k.penyewa}</td>
      <td>${k.durasi}</td>
      <td>Rp ${k.total}</td>
      <td>${new Date(k.tanggal).toLocaleString()}</td>
    `;
    kasTable.appendChild(tr);
  });
}

// ======================================================
// REALTIME KAS
// ======================================================
function watchKasRealtime() {
  supabase
    .channel("kas-realtime")
    .on("postgres_changes", { event:"*", schema:"public", table:"kas" },
        () => loadKas())
    .subscribe();
}

// ======================================================
// EXPORT PDF
// ======================================================
pdfBtn.onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text("Laporan Buku Kas Rental Motor", 10, 10);

  let y = 20;
  [...kasTable.children].forEach(row => {
    const cols = [...row.children].map(td => td.textContent).join(" | ");
    doc.text(cols, 10, y);
    y += 10;
  });

  doc.save("buku-kas.pdf");
};

</script>

</body>
</html>
