<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sewa Motor â€” Supabase (Realtime + Admin/User)</title>

<!-- icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --accent:#2b7a78;
  }
  body{font-family:Inter,system-ui,Arial; background:var(--bg); margin:0; padding:20px; color:#222}
  .container{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.gray{background:#777}
  .btn.danger{background:#b03}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(20,20,60,0.06)}
  .motor-img{height:140px;border-radius:8px;background:linear-gradient(90deg,#e8f8f7,#f0f6ff);display:flex;align-items:center;justify-content:center;font-size:48px;overflow:hidden}
  .meta{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
  .status{padding:6px 8px;border-radius:8px;font-weight:600}
  .available{background:#e6fff9;color:#007a5f}
  .rented{background:#fff2f2;color:#b90909}
  .actions{margin-top:10px;display:flex;gap:8px}
  .small{font-size:13px;color:#666}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,10,20,0.45);z-index:10}
  .modal.show{display:flex}
  .dialog{background:var(--card);padding:18px;border-radius:12px;width:420px;box-shadow:0 20px 60px rgba(10,10,40,0.3);max-height:90vh;overflow:auto}
  label{display:block;margin-top:10px;font-size:13px}
  input[type="text"],input[type="tel"],input[type="number"],select,input[type="datetime-local"],textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
  .row{display:flex;gap:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .admin-panel{display:none;margin-top:18px}
  footer{margin-top:20px;text-align:center;color:#666}
  img.motor-thumb{width:100%;height:100%;object-fit:cover;border-radius:8px}
  .top-right {display:flex;gap:8px;align-items:center}
  .badge-admin{background:#333;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px}
  .user-rentals{margin-top:12px}
</style>

<!-- jsPDF & autotable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>Aplikasi Sewa Motor (Supabase)</h1>
    <div class="top-right">
      <div id="userInfo" class="small"></div>
      <button id="adminBtn" class="btn"><i class="fa-solid fa-lock"></i> Admin</button>
      <button id="logoutBtn" class="btn gray" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </header>

  <section>
    <p class="small">Klik <strong>Sewa</strong> untuk memesan â€” update status realtime. Hanya <em>admin</em> yang dapat menambah / mengubah data motor dan melihat buku kas.</p>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <button id="addBike" class="btn" style="background:#2b7a78;display:none"><i class="fa-solid fa-plus"></i> Tambah Motor</button>
      <button id="downloadPdf" class="btn" style="display:none"><i class="fa-solid fa-file-pdf"></i> Download Buku Kas (PDF)</button>
      <div style="margin-left:auto" class="small">Status Realtime: <span id="realtimeStatus">connected</span></div>
    </div>

    <div class="grid" id="motorGrid"></div>

    <div class="user-rentals card" id="userRentals" style="margin-top:18px;display:none">
      <h4>Riwayat Sewa Anda</h4>
      <div id="userRentalsList" class="small"></div>
    </div>

  </section>

  <!-- Modal Sewa -->
  <div id="rentModal" class="modal"><div class="dialog">
    <h3 id="modalTitle">Form Sewa</h3>
    <form id="rentForm">
      <input type="hidden" id="bikeId" />
      <label>Nama penyewa</label><input id="name" type="text" required />
      <label>No. HP</label><input id="phone" type="tel" pattern="[0-9+ ]*" required />
      <label>Durasi sewa (jam)</label><input id="hours" type="number" min="1" value="1" required />
      <label>Tanggal & Waktu Mulai Sewa</label><input id="startDateTime" type="datetime-local" required />
      <p class="muted" id="endDateTimePreview">Selesai sewa: -</p>
      <label>Ketentuan</label>
      <div class="row">
        <label style="flex:1"><input id="idKtp" type="checkbox"/> Memiliki KTP</label>
        <label style="flex:1"><input id="idStudent" type="checkbox"/> Kartu Mahasiswa</label>
      </div>
      <label>Tarif</label>
      <select id="rateSelect">
        <option value="5000|60000">Standar â€” Rp 5.000 / jam â€¢ Rp 60.000 / 24 jam</option>
        <option value="10000|70000">Premium â€” Rp 10.000 / jam â€¢ Rp 70.000 / 24 jam</option>
      </select>
      <p class="muted" id="pricePreview">Total: Rp 5.000</p>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button type="button" id="closeModal" class="btn gray">Batal</button>
        <button type="submit" class="btn">Konfirmasi Sewa</button>
      </div>
    </form>
  </div></div>

  <!-- Modal Tambah Motor -->
  <div id="addBikeModal" class="modal"><div class="dialog">
    <h3>Tambah Motor Baru</h3>
    <form id="addBikeForm">
      <label>Gambar Motor (opsional)</label>
      <input type="file" id="bikeImageInput" accept="image/*"/>
      <label>Nama Motor</label>
      <input type="text" id="bikeNameInput" required/>
      <label>Tarif per Jam (Rp)</label>
      <input type="number" id="bikeRateHour" min="1000" required/>
      <label>Tarif per Hari (Rp)</label>
      <input type="number" id="bikeRateDay" min="10000" required/>
      <label>Emoji / Ikon Motor (opsional)</label>
      <input type="text" id="bikeEmoji" placeholder="ðŸ›µ atau ðŸï¸"/>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button type="button" id="cancelAddBike" class="btn gray">Batal</button>
        <button type="submit" class="btn">Simpan</button>
      </div>
    </form>
  </div></div>

  <!-- Admin Panel -->
  <div class="admin-panel card" id="adminPanel">
    <h3>Halaman Admin â€” Riwayat Sewa</h3>
    <div style="overflow:auto;max-height:320px">
      <table id="rentalTable">
        <thead><tr><th>Nama</th><th>No HP</th><th>Motor</th><th>Durasi</th><th>Tarif</th><th>Total</th><th>Mulai</th><th>Selesai</th><th>Kembali</th><th>Status</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <footer>Made for you â€” buka file <strong>index.html</strong> di browser. Jangan lupa setting SUPABASE_URL & ANON KEY.</footer>
</div>

<script>
/* -------------------- KONFIGURASI (Ganti sesuai project mu) -------------------- */
const SUPABASE_URL = "https://kiupbqmskhhlvvzuqkal.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdXBicW1za2hobHZ2enVxa2FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTAwNzMsImV4cCI6MjA3ODY2NjA3M30.R8dLWGsma65c-2lvBLv-iY38rso19KiPjECNTy-tfEY";
/* ------------------------------------------------------------------------------ */

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 10 } } });

window.bikes = [];
window.rentals = [];
let isAdmin = false;
const ADMIN_EMAIL = "kinkinka90@gmail.com"; // ganti bila perlu

const motorGrid = document.getElementById("motorGrid");
const rentalTableBody = document.querySelector("#rentalTable tbody");
const adminPanel = document.getElementById("adminPanel");
const addBikeBtn = document.getElementById("addBike");
const downloadPdfBtn = document.getElementById("downloadPdf");
const adminBtn = document.getElementById("adminBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfoEl = document.getElementById("userInfo");
const userRentalsCard = document.getElementById("userRentals");
const userRentalsList = document.getElementById("userRentalsList");

/* -------------------- helpers -------------------- */
function numberWithDots(x){ if(x==null) return "0"; return String(x).replace(/\B(?=(\d{3})+(?!\d))/g,"."); }
function escapeHtml(s){ if(s===undefined || s===null) return ""; return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function toLocal(dt){ try { return new Date(dt).toLocaleString("id-ID",{dateStyle:"short",timeStyle:"short"}) } catch(e){ return dt } }

/* -------------------- Render UI -------------------- */
function renderBikes(){
  motorGrid.innerHTML = "";
  (window.bikes||[]).forEach(b=>{
    const card=document.createElement("div");
    card.className="card";
    const imgHtml = b.image_url ? `<img src="${b.image_url}" class="motor-thumb" alt="${escapeHtml(b.name)}">` : (b.image_emoji? `<div style="font-size:36px">${escapeHtml(b.image_emoji)}</div>` : `<div style="font-size:36px">ðŸ›µ</div>`);
    card.innerHTML = `
      <div class="motor-img">${imgHtml}</div>
      <div style="margin-top:10px"><strong>${escapeHtml(b.name)}</strong></div>
      <div class="meta">
        <div class="small">Tarif: Rp ${numberWithDots(b.rate_hour)}/jam</div>
        <div class="status ${b.status==="available"?"available":"rented"}">${b.status==="available"?"Available":"Disewa"}</div>
      </div>
      <div class="actions">
        <button class="btn rentBtn" data-id="${b.id}" ${b.status!=="available"?"disabled":""}>Sewa</button>
        ${isAdmin ? `<button class="btn gray" data-edit="${b.id}"><i class='fa-solid fa-pen'></i></button>
                     <button class="btn danger" data-delete="${b.id}"><i class='fa-solid fa-trash'></i></button>` : ""}
      </div>`;
    motorGrid.appendChild(card);
  });
}

/* render rental table (admin) */
function renderRentalTable(){
  rentalTableBody.innerHTML = "";
  (window.rentals||[]).slice().reverse().forEach(r=>{
    let actionBtns = `<button class="btn gray" data-edit-rental="${r.id}"><i class='fa-solid fa-pen'></i></button>
    <button class="btn danger" data-delete-rental="${r.id}" data-bike="${r.bike_id}"><i class='fa-solid fa-trash'></i></button>`;
    if(r.status==="Disewa"||r.status==="disewa"){
      actionBtns = `<button class="btn" data-complete="${r.id}" data-bike="${r.bike_id}"><i class='fa-solid fa-check'></i> Selesai</button>` + actionBtns;
    }
    rentalTableBody.innerHTML += `<tr>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.phone)}</td>
      <td>${escapeHtml(r.bike_name||r.bikeName||"")}</td>
      <td>${r.hours}</td>
      <td>Rp ${numberWithDots(r.rateHour||r.rate_hour)}/jam</td>
      <td>Rp ${numberWithDots(r.total)}</td>
      <td>${r.startTime?toLocal(r.startTime):"-"}</td>
      <td>${r.endTime?toLocal(r.endTime):"-"}</td>
      <td>${r.returnTime?toLocal(r.returnTime):"-"}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${actionBtns}</td>
    </tr>`;
  });
}

/* render user's own rentals */
function renderUserRentals(userEmail){
  if(!userEmail){ userRentalsCard.style.display='none'; return; }
  const mine = (window.rentals||[]).filter(r => (r.user_email && r.user_email===userEmail) || (r.phone && r.phone===localStorage.getItem('lastPhone')));
  if(mine.length===0){ userRentalsList.innerHTML = "<div class='small'>Belum ada riwayat sewa Anda.</div>"; userRentalsCard.style.display='block'; return; }
  let html = "<ul>";
  mine.slice().reverse().forEach(r=>{
    html += `<li><strong>${escapeHtml(r.bike_name||r.bikeName)}</strong> â€” ${escapeHtml(r.status)} â€” Mulai: ${r.startTime?toLocal(r.startTime):"-"}</li>`;
  });
  html += "</ul>";
  userRentalsList.innerHTML = html;
  userRentalsCard.style.display='block';
}

/* -------------------- LOAD INITIAL DATA + SUBSCRIBE REALTIME -------------------- */
async function loadData(){
  // Bikes
  const { data: bikesData, error: errB } = await supabase.from('bikes').select('*').order('created_at', { ascending: true });
  if(errB) console.error("Error fetching bikes:", errB);
  else { window.bikes = bikesData || []; renderBikes(); }

  // Rentals
  const { data: rentalsData, error: errR } = await supabase.from('rentals').select('*').order('created_at', { ascending: true });
  if(errR) console.error("Error fetching rentals:", errR);
  else { window.rentals = rentalsData || []; renderRentalTable(); checkAndRenderUser(); }

  // Realtime subscriptions for bikes
  supabase.channel('public:bikes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'bikes' }, payload => {
      handleBikeRealtime(payload);
    })
    .subscribe()
    .then(()=> document.getElementById('realtimeStatus').textContent='listening');

  // Realtime subscriptions for rentals
  supabase.channel('public:rentals')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'rentals' }, payload => {
      handleRentalRealtime(payload);
    })
    .subscribe();
}
loadData();

function handleBikeRealtime(payload){
  const ev = payload.eventType;
  const rec = payload.record;
  const old = payload.old_record;
  if(ev === 'INSERT'){ window.bikes.push(rec); }
  else if(ev === 'UPDATE'){ const i=window.bikes.findIndex(x=>String(x.id)===String(rec.id)); if(i>-1) window.bikes[i]=rec; else window.bikes.push(rec); }
  else if(ev === 'DELETE'){ window.bikes = window.bikes.filter(x => String(x.id)!==String(old.id)); }
  renderBikes();
}

function handleRentalRealtime(payload){
  const ev = payload.eventType;
  const rec = payload.record;
  const old = payload.old_record;
  if(ev === 'INSERT'){ window.rentals.push(rec); }
  else if(ev === 'UPDATE'){ const i=window.rentals.findIndex(x=>String(x.id)===String(rec.id)); if(i>-1) window.rentals[i]=rec; else window.rentals.push(rec); }
  else if(ev === 'DELETE'){ window.rentals = window.rentals.filter(x=>String(x.id)!==String(old.id)); }
  renderRentalTable();
  checkAndRenderUser();
}

/* -------------------- RENTAL MODAL + LOGIC -------------------- */
const rentModal = document.getElementById("rentModal");
const rentForm = document.getElementById("rentForm");
const pricePreview = document.getElementById("pricePreview");

function updatePricePreview(){
  const val = document.getElementById("rateSelect").value.split("|");
  const hour = parseInt(val[0]);
  const day = parseInt(val[1]);
  let h = parseInt(document.getElementById("hours").value||1);
  if(h<1) h=1;
  const days = Math.floor(h/24), rem = h%24;
  const total = days*day + rem*hour;
  pricePreview.textContent = `Total: Rp ${numberWithDots(total)}`;
}
function updateEndDateTime(){
  const h = parseInt(document.getElementById("hours").value||1);
  const start = document.getElementById("startDateTime").value;
  if(!start){ document.getElementById("endDateTimePreview").textContent="Selesai sewa: -"; return; }
  const end = new Date(new Date(start).getTime() + h*60*60*1000);
  document.getElementById("endDateTimePreview").textContent = "Selesai sewa: " + end.toLocaleString("id-ID",{dateStyle:"short",timeStyle:"short"});
}
document.getElementById("hours").addEventListener("input", ()=>{ updatePricePreview(); updateEndDateTime(); });
document.getElementById("startDateTime").addEventListener("change", updateEndDateTime);
document.getElementById("rateSelect").addEventListener("change", updatePricePreview);
document.getElementById("closeModal").addEventListener("click", ()=>{ rentModal.classList.remove("show"); rentForm.reset(); });

/* handle rent button clicks (delegation) */
document.body.addEventListener("click", async (e)=>{
  // rent button on card
  if(e.target.classList.contains("rentBtn")){
    const id = e.target.dataset.id;
    const b = window.bikes.find(x=>String(x.id)===String(id));
    if(!b) return alert("Motor tidak ditemukan!");
    document.getElementById("bikeId").value = id;
    document.getElementById("modalTitle").textContent = "Sewa: "+b.name;
    document.getElementById("rateSelect").value = `${b.rate_hour||b.rateHour||5000}|${b.rate_day||b.rateDay||60000}`;
    document.getElementById("hours").value = 1;
    updatePricePreview(); updateEndDateTime();
    rentModal.classList.add("show");
  }

  // admin edit bike
  if(e.target.closest("[data-edit]")){
    if(!isAdmin) return alert("Hanya admin yang bisa mengedit motor!");
    const bikeId = e.target.closest("[data-edit]").getAttribute("data-edit");
    editBikePrompt(bikeId);
  }

  // admin delete bike
  if(e.target.closest("[data-delete]")){
    if(!isAdmin) return alert("Hanya admin yang bisa menghapus motor!");
    const bikeId = e.target.closest("[data-delete]").getAttribute("data-delete");
    deleteBikeConfirm(bikeId);
  }

  // rentals table actions
  if(e.target.closest("[data-complete]")){
    if(!isAdmin) return alert("Hanya admin yang bisa menandai selesai!");
    const id = e.target.closest("[data-complete]").getAttribute("data-complete");
    const bike = e.target.closest("[data-complete]").getAttribute("data-bike");
    completeRental(id, bike);
  }
  if(e.target.closest("[data-delete-rental]")){
    if(!isAdmin) return alert("Hanya admin yang bisa menghapus sewa!");
    const id = e.target.closest("[data-delete-rental]").getAttribute("data-delete-rental");
    const bike = e.target.closest("[data-delete-rental]").getAttribute("data-bike");
    deleteRentalConfirm(id, bike);
  }
  if(e.target.closest("[data-edit-rental]")){
    if(!isAdmin) return alert("Hanya admin yang bisa edit sewa!");
    const id = e.target.closest("[data-edit-rental]").getAttribute("data-edit-rental");
    editRentalPrompt(id);
  }
});

/* submit rent */
rentForm.addEventListener("submit", async (ev)=>{
  ev.preventDefault();
  const bikeId = document.getElementById("bikeId").value;
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const hours = parseInt(document.getElementById("hours").value);
  const ktp = document.getElementById("idKtp").checked;
  const student = document.getElementById("idStudent").checked;
  if(!ktp && !student){ alert("Harus memiliki KTP atau Kartu Mahasiswa!"); return; }
  const [rateHour, rateDay] = document.getElementById("rateSelect").value.split("|").map(Number);
  const days = Math.floor(hours/24), rem = hours%24;
  const total = days*rateDay + rem*rateHour;
  const startTime = document.getElementById("startDateTime").value;
  const endTime = new Date(new Date(startTime).getTime()+hours*60*60*1000).toISOString();
  const bike = window.bikes.find(b=>String(b.id)===String(bikeId));
  if(!bike) return alert("Motor tidak ditemukan!");

  // Insert rental with user email if logged
  const user = await supabase.auth.getUser();
  const userEmail = (user && user.data && user.data.user) ? user.data.user.email : null;

  const newRental = {
    bike_id: bikeId,
    bike_name: bike.name,
    name, phone, hours, rateHour, rateDay, total,
    startTime, endTime,
    status: "Disewa",
    idDesc: ktp&&student ? "KTP & Kartu Mahasiswa" : ktp ? "KTP" : "Kartu Mahasiswa",
    user_email: userEmail || null,
    created_at: new Date().toISOString()
  };

  const { error: errIns } = await supabase.from('rentals').insert([newRental]);
  if(errIns){ console.error(errIns); alert("Gagal menyimpan sewa: "+errIns.message); return; }

  // Update bike status
  const { error: errUpd } = await supabase.from('bikes').update({ status: "rented" }).eq('id', bikeId);
  if(errUpd) console.error("Gagal update bike status:", errUpd);

  // Save last phone to match user rentals (optional)
  localStorage.setItem('lastPhone', phone);

  // UI update via realtime
  rentModal.classList.remove("show");
  rentForm.reset();

  const pesan = `Halo ${name}, terima kasih telah menyewa ${bike.name}\nTotal: Rp ${numberWithDots(total)}\nMulai: ${new Date(startTime).toLocaleString()} \nSelesai: ${new Date(endTime).toLocaleString()}`;
  // open WA (optional)
  window.open("https://wa.me/"+phone.replace(/\D/g,"")+"?text="+encodeURIComponent(pesan));
});

/* -------------------- ADD / EDIT / DELETE BIKES (ADMIN) -------------------- */
const addBikeModal = document.getElementById("addBikeModal");
const addBikeForm = document.getElementById("addBikeForm");
document.getElementById("addBike").addEventListener("click", ()=>{ addBikeModal.classList.add("show"); });
document.getElementById("cancelAddBike").addEventListener("click", ()=>{ addBikeModal.classList.remove("show"); addBikeForm.reset(); });

addBikeForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!isAdmin) return alert("Hanya admin yang bisa menambah motor!");
  const name = document.getElementById("bikeNameInput").value.trim();
  const rateHour = parseInt(document.getElementById("bikeRateHour").value,10);
  const rateDay = parseInt(document.getElementById("bikeRateDay").value,10);
  const emoji = document.getElementById("bikeEmoji").value.trim() || null;
  const file = document.getElementById("bikeImageInput").files[0];
  if(!name || isNaN(rateHour) || isNaN(rateDay)) return alert("Isi nama dan tarif dengan benar.");

  let publicUrl = null;
  if(file){
    try{
      const path = `bikes/${Date.now()}_${file.name}`;
      const up = await supabase.storage.from('bikes').upload(path, file, { cacheControl: '3600', upsert: false });
      if(up.error) throw up.error;
      const { data: urlData } = supabase.storage.from('bikes').getPublicUrl(path);
      publicUrl = urlData.publicUrl;
    }catch(err){
      console.warn("Storage upload failed:", err);
    }
  }

  const bikeRecord = {
    name,
    rate_hour: rateHour,
    rate_day: rateDay,
    image_emoji: emoji,
    image_url: publicUrl,
    status: "available",
    created_at: new Date().toISOString()
  };

  const { error } = await supabase.from('bikes').insert([bikeRecord]);
  if(error){ console.error(error); alert("Gagal menambah motor: "+error.message); return; }

  alert("Motor berhasil ditambahkan!");
  addBikeForm.reset();
  addBikeModal.classList.remove("show");
});

/* edit bike prompt */
async function editBikePrompt(bikeId){
  const bike = window.bikes.find(b => String(b.id)===String(bikeId));
  if(!bike) return alert("Motor tidak ditemukan.");
  const newName = prompt("Nama motor baru:", bike.name);
  if(newName === null) return;
  const newRateHour = parseInt(prompt("Tarif per jam (Rp):", bike.rate_hour), 10);
  const newRateDay = parseInt(prompt("Tarif per hari (Rp):", bike.rate_day), 10);
  if(isNaN(newRateHour) || isNaN(newRateDay)) return alert("Tarif harus angka.");
  const { error } = await supabase.from('bikes').update({ name: newName.trim(), rate_hour: newRateHour, rate_day: newRateDay }).eq('id', bikeId);
  if(error) { console.error(error); alert("Gagal update: "+error.message); }
  else alert("Data motor diupdate.");
}

async function deleteBikeConfirm(bikeId){
  if(!confirm("Yakin menghapus motor ini?")) return;
  const { error } = await supabase.from('bikes').delete().eq('id', bikeId);
  if(error) { console.error(error); alert("Gagal hapus motor: "+error.message); return; }
  alert("Motor dihapus.");
}

/* -------------------- RENTAL ADMIN ACTIONS -------------------- */
async function completeRental(rentalId, bikeId){
  const now = new Date().toISOString();
  const { error: e1 } = await supabase.from('rentals').update({ status: "Selesai", returnTime: now }).eq('id', rentalId);
  const { error: e2 } = await supabase.from('bikes').update({ status: "available" }).eq('id', bikeId);
  if(e1 || e2){ console.error(e1 || e2); alert("Terjadi kesalahan saat menyelesaikan sewa."); return; }
  alert("Sewa selesai & status motor dikembalikan.");
}
async function deleteRentalConfirm(rentalId, bikeId){
  if(!confirm("Hapus record sewa ini?")) return;
  const { error } = await supabase.from('rentals').delete().eq('id', rentalId);
  if(error) { console.error(error); alert("Gagal hapus: "+error.message); return; }
  await supabase.from('bikes').update({ status: "available" }).eq('id', bikeId);
  alert("Sewa dihapus.");
}
async function editRentalPrompt(rentalId){
  const res = await supabase.from('rentals').select('*').eq('id', rentalId).single();
  if(res.error) return alert("Sewa tidak ditemukan.");
  const r = res.data;
  const newHours = parseInt(prompt("Durasi baru (jam):", r.hours), 10);
  const newRate = parseInt(prompt("Tarif per jam (Rp):", r.rateHour||r.rate_hour), 10);
  if(isNaN(newHours) || isNaN(newRate)) return alert("Input tidak valid.");
  const days = Math.floor(newHours/24), rem = newHours%24, newTotal = days*(r.rateDay||r.rate_day) + rem*newRate;
  const updates = { hours: newHours, rateHour: newRate, total: newTotal };
  if(r.startTime){ const newEnd = new Date(new Date(r.startTime).getTime() + newHours*60*60*1000).toISOString(); updates.endTime = newEnd; }
  const { error } = await supabase.from('rentals').update(updates).eq('id', rentalId);
  if(error) { console.error(error); alert("Gagal update sewa: "+error.message); return; }
  alert("Data sewa diperbarui.");
}

/* -------------------- PDF Buku Kas -------------------- */
downloadPdfBtn.addEventListener("click", ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','pt','a4');
  doc.text("Buku Kas Rental Motor", 40, 40);
  const rows = window.rentals.map(r => [
    r.name, r.phone, r.bike_name||r.bikeName||"", r.hours, `Rp ${numberWithDots(r.rateHour||r.rate_hour)}`, `Rp ${numberWithDots(r.total)}`, r.startTime||"-", r.endTime||"-", r.returnTime||"-", r.status
  ]);
  doc.autoTable({ head:[["Nama","No HP","Motor","Durasi","Tarif","Total","Mulai","Selesai","Kembali","Status"]], body: rows, startY:70 });
  doc.save("BukuKasSewaMotor.pdf");
});

/* -------------------- AUTH / ADMIN / SESSION -------------------- */
async function checkSession(){
  const { data } = await supabase.auth.getSession();
  const session = data.session;
  if(session && session.user){
    // logged in
    const email = session.user.email;
    userInfoEl.innerHTML = `<strong>${escapeHtml(email)}</strong>`;
    logoutBtn.style.display = "inline-block";
    adminBtn.style.display = "none";
    // set admin
    isAdmin = (email === ADMIN_EMAIL);
    if(isAdmin){
      document.getElementById('addBike').style.display = 'inline-block';
      document.getElementById('downloadPdf').style.display = 'inline-block';
      adminPanel.style.display = 'block';
    } else {
      document.getElementById('addBike').style.display = 'none';
      document.getElementById('downloadPdf').style.display = 'none';
      adminPanel.style.display = 'none';
    }
    // show user rentals
    renderUserRentals(email);
  } else {
    // not logged in
    userInfoEl.innerHTML = '';
    logoutBtn.style.display = "none";
    adminBtn.style.display = "inline-block";
    document.getElementById('addBike').style.display = 'none';
    document.getElementById('downloadPdf').style.display = 'none';
    adminPanel.style.display = 'none';
    renderUserRentals(null);
  }
}
checkSession();

// adminBtn -> sign in with google
adminBtn.addEventListener("click", async ()=>{
  await supabase.auth.signInWithOAuth({ provider: "google", options: { redirectTo: window.location.href }});
});

// logout
logoutBtn.addEventListener("click", async ()=>{
  await supabase.auth.signOut();
  alert("Logout berhasil");
  location.reload();
});

// auth state change
supabase.auth.onAuthStateChange((event, session)=>{
  // console.log("auth event", event, session);
  checkSession();
});

/* helper to check and render user-specific info */
function checkAndRenderUser(){
  supabase.auth.getSession().then(({ data })=>{
    const session = data.session;
    const email = session && session.user ? session.user.email : null;
    renderUserRentals(email);
  });
}

/* -------------------- ensure UI events for add/edit/delete from delegation (buttons outside) -------------------- */
document.addEventListener("click", (e)=>{
  // fallback: handled above via delegation
});

/* -------------------- EOF -------------------- */
</script>
</body>
</html>
