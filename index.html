<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aplikasi Sewa Motor</title>

<!-- ===== STYLE MINIMALIS ===== -->
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0; padding: 0;
  background:#f5f5f5;
}
header {
  background:#222;
  padding:15px;
  color:white;
  text-align:center;
  font-size:20px;
}
.container {
  max-width: 900px;
  margin: 20px auto;
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
button {
  padding:10px 15px;
  border:none;
  border-radius:8px;
  background:#333;
  color:white;
  cursor:pointer;
  margin:5px 0;
}
button:hover { background:#555; }

input, select {
  width:100%;
  padding:10px;
  margin:5px 0 10px 0;
  border-radius:6px;
  border:1px solid #ccc;
}

.card {
  background:white;
  padding:15px;
  margin:10px 0;
  border-radius:10px;
  border:1px solid #eee;
}

.admin-only {
  border-left:5px solid #c00;
  padding-left:10px;
}

.hidden { display:none; }
.title { font-weight:bold; font-size:18px; margin-bottom:10px; }
.small { font-size:13px; color:#666; }

.list { margin-top:15px; }
.list .item {
  padding:10px;
  border-bottom:1px solid #eee;
}

.muted { color:#777; font-size:12px; }
</style>

<!-- ===== SUPABASE ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ===== jsPDF ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<header>Aplikasi Sewa Motor</header>

<div class="container">

  <!-- LOGIN PANEL -->
  <div id="loginPanel">
    <p>Silakan login menggunakan Google:</p>
    <button onclick="loginGoogle()">Login dengan Google</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">

    <p>Login sebagai: <span id="userEmail"></span></p>

    <button onclick="logout()">Logout</button>
    <hr>

    <!-- ADMIN BLOCK -->
    <div id="adminPanel" class="hidden admin-only">

      <div class="title">Menu Admin</div>

      <button onclick="showSection('addMotor')">Tambah Motor</button>
      <button onclick="showSection('listMotors')">Daftar Motor (Edit/Hapus)</button>
      <button onclick="showSection('adminRentals')">Semua Transaksi</button>
      <button onclick="exportDailyPDF()">Export PDF Laporan Hari Ini</button>
      <button onclick="exportAllPDF()">Export PDF Semua Data</button>

      <hr>
    </div>

    <!-- USER MENU -->
    <div class="title">Menu Pengguna</div>

    <button onclick="showSection('rentMotor')">Sewa Motor</button>
    <button onclick="showSection('history')">Riwayat Saya</button>

    <hr>

    <!-- ===== SECTIONS ===== -->

    <!-- ADD MOTOR -->
    <div id="addMotor" class="hidden">
      <div class="title">Tambah Motor</div>
      <input id="bikeName" placeholder="Nama motor">
      <input id="bikePlate" placeholder="Plat nomor">
      <button onclick="addMotor()">Simpan</button>
      <div id="resultAddMotor"></div>
    </div>

    <!-- LIST MOTORS -->
    <div id="listMotors" class="hidden">
      <div class="title">Daftar Motor</div>
      <div id="motorList"></div>
    </div>

    <!-- RENT MOTOR -->
    <div id="rentMotor" class="hidden">
      <div class="title">Sewa Motor</div>
      <select id="rentBikeSelect"></select>
      <input id="rentName" placeholder="Nama penyewa">
      <input id="rentHours" placeholder="Durasi jam">
      <button onclick="rentMotor()">Sewa</button>
      <div id="resultRent"></div>
    </div>

    <!-- USER HISTORY -->
    <div id="history" class="hidden">
      <div class="title">Riwayat Sewa Saya</div>
      <div id="myHistoryList"></div>
    </div>

    <!-- ADMIN RENTALS -->
    <div id="adminRentals" class="hidden">
      <div class="title">Semua Transaksi</div>
      <div id="adminRentalList"></div>
    </div>

  </div>
</div>

<script>
// =========================================================
// CONFIG SUPABASE
// =========================================================
const SUPABASE_URL = "https://kiupbqmskhhlvvzuqkal.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpdXBicW1za2hobHZ2enVxa2FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTAwNzMsImV4cCI6MjA3ODY2NjA3M30.R8dLWGsma65c-2lvBLv-iY38rso19KiPjECNTy-tfEY";
const ADMIN_EMAIL = "kinkinka90@gmail.com";

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// =========================================================
// GOOGLE LOGIN
// =========================================================
async function loginGoogle() {
  try {
    const { data, error } = await supa.auth.signInWithOAuth({ provider: "google" });
    if (error) console.error("Login error:", error.message);
  } catch(err) {
    console.error(err);
  }
}

async function logout() {
  await supa.auth.signOut();
  location.reload();
}

// =========================================================
// AUTH STATE CHANGE
// =========================================================
supa.auth.onAuthStateChange(async (event, session) => {
  if (session?.user) {
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("userEmail").innerText = session.user.email;

    if (session.user.email === ADMIN_EMAIL) {
      document.getElementById("adminPanel").classList.remove("hidden");
    }

    await loadMotors();
    await loadUserHistory();
    await loadAllRentals();
    await loadRentOptions();
  }
});

// =========================================================
// SWITCH UI
// =========================================================
function showSection(id) {
  ["addMotor","listMotors","rentMotor","history","adminRentals"].forEach(sec=>{
    document.getElementById(sec).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// =========================================================
// CRUD MOTOR
// =========================================================
async function addMotor() {
  const name = bikeName.value.trim();
  const plate = bikePlate.value.trim();
  if (!name || !plate) { resultAddMotor.innerHTML="Semua field wajib diisi"; return; }

  await supa.from("bikes").insert({ name, plate, available:true });
  resultAddMotor.innerHTML="Motor berhasil ditambah!";
  bikeName.value = bikePlate.value = "";
  await loadMotors();
  await loadRentOptions();
}

async function loadMotors() {
  const { data } = await supa.from("bikes").select();
  motorList.innerHTML = data.map(b=>`
    <div class="card">
      <b>${b.name}</b> (${b.plate})<br>
      Status: ${b.available ? "Tersedia" : "Dipakai"}<br><br>
      <button onclick="deleteMotor(${b.id})">Hapus</button>
    </div>
  `).join("");
}

async function deleteMotor(id) {
  await supa.from("bikes").delete().eq("id", id);
  await loadMotors();
  await loadRentOptions();
}

// =========================================================
// SEWA MOTOR
// =========================================================
async function loadRentOptions() {
  const { data } = await supa.from("bikes").select().eq("available", true);
  rentBikeSelect.innerHTML = data.map(b=>`<option value="${b.id}">${b.name} (${b.plate})</option>`).join("");
}

async function rentMotor() {
  const bikeId = rentBikeSelect.value;
  const renter = rentName.value.trim();
  const hours = parseInt(rentHours.value);
  if (!renter || !hours) { resultRent.innerHTML="Semua field wajib diisi"; return; }

  const user = (await supa.auth.getUser()).data.user;
  await supa.from("rentals").insert({
    bike_id: bikeId,
    renter_name: renter,
    hours,
    status:"ongoing",
    user_email: user.email
  });

  await supa.from("bikes").update({ available:false }).eq("id", bikeId);
  resultRent.innerHTML="Sewa berhasil!";
  rentName.value = rentHours.value = "";
  await loadMotors();
  await loadRentOptions();
  await loadUserHistory();
  await loadAllRentals();
}

// =========================================================
// RIWAYAT USER
// =========================================================
async function loadUserHistory() {
  const user = (await supa.auth.getUser()).data.user;
  const { data } = await supa.from("rentals")
    .select("*, bikes(*)")
    .eq("user_email", user.email)
    .order("id",{ascending:false});
  myHistoryList.innerHTML = data.map(r=>`
    <div class="card">
      <b>${r.bikes.name}</b> (${r.bikes.plate})<br>
      Durasi: ${r.hours} jam<br>
      Status: ${r.status}
    </div>
  `).join("");
}

// =========================================================
// ADMIN â€“ SEMUA TRANSAKSI
// =========================================================
async function loadAllRentals() {
  const { data } = await supa.from("rentals").select("*, bikes(*)").order("id",{ascending:false});
  adminRentalList.innerHTML = data.map(r=>`
    <div class="card">
      <b>${r.bikes.name}</b> (${r.bikes.plate})<br>
      Penyewa: ${r.renter_name}<br>
      Durasi: ${r.hours} jam<br>
      Status: ${r.status}<br><br>
      ${r.status==="ongoing"?`<button onclick="finishRental(${r.id},${r.bike_id})">Selesai</button>`:""}
      <button onclick="deleteRental(${r.id})">Hapus Riwayat</button>
    </div>
  `).join("");
}

async function finishRental(id,bikeId) {
  await supa.from("rentals").update({status:"finished"}).eq("id",id);
  await supa.from("bikes").update({available:true}).eq("id",bikeId);
  await loadMotors();
  await loadAllRentals();
  await loadUserHistory();
}

async function deleteRental(id) {
  await supa.from("rentals").delete().eq("id",id);
  await loadAllRentals();
  await loadUserHistory();
}

// =========================================================
// PDF EXPORT
// =========================================================
async function exportDailyPDF() {
  const today = new Date().toISOString().slice(0,10);
  const { data } = await supa.from("rentals")
    .select("*, bikes(*)")
    .gte("created_at", today + "T00:00:00")
    .lte("created_at", today + "T23:59:59");

  const doc = new jspdf.jsPDF();
  doc.setFontSize(16);
  doc.text("Laporan Harian " + today, 10, 10);
  let y=20;
  data.forEach(r=>{
    doc.setFontSize(12);
    doc.text(`${r.bikes.name} (${r.bikes.plate}) - ${r.renter_name} - ${r.status}`,10,y);
    y+=10;
  });
  doc.save(`laporan_${today}.pdf`);
}

async function exportAllPDF() {
  const { data } = await supa.from("rentals").select("*, bikes(*)");
  const doc = new jspdf.jsPDF();
  doc.setFontSize(16);
  doc.text("Laporan Semua Transaksi", 10, 10);
  let y=20;
  data.forEach(r=>{
    doc.setFontSize(12);
    doc.text(`${r.bikes.name} (${r.bikes.plate}) - ${r.renter_name} - ${r.status}`,10,y);
    y+=10;
  });
  doc.save("semua_transaksi.pdf");
}

</script>
</body>
</html>
